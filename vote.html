<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      name="description"
      content="Vote for today's best memes - $ARCH holders decide what gets archived forever"
    />
    <title>Vote - Archive of Meme ($ARCH)</title>
    <link rel="stylesheet" href="css/styles.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Kalam:wght@400;700&family=Permanent+Marker&family=Comic+Neue:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <style>
      .vote-hero {
        background: linear-gradient(
          135deg,
          var(--color-gold) 0%,
          var(--color-accent) 100%
        );
        color: var(--color-white);
        padding: 60px 40px;
        text-align: center;
        position: relative;
        overflow: hidden;
        border-bottom: 4px solid var(--color-ink);
      }

      .vote-hero::before {
        content: "üó≥Ô∏è";
        position: absolute;
        font-size: 200px;
        opacity: 0.1;
        right: -50px;
        top: 50%;
        transform: translateY(-50%) rotate(-15deg);
      }

      .vote-requirements {
        background: var(--color-accent);
        color: var(--color-white);
        padding: 20px;
        border: 3px solid var(--color-ink);
        border-radius: var(--radius-sketch);
        margin: 20px auto;
        max-width: 600px;
        text-align: center;
        font-family: var(--font-sketch);
        font-weight: 700;
        box-shadow: 3px 3px 0px var(--color-ink);
        transform: rotate(-0.5deg);
      }

      .not-voting-phase {
        background: var(--color-paper);
        border: 3px dashed var(--color-ink);
        border-radius: var(--radius-sketch);
        padding: 40px;
        margin: 40px auto;
        max-width: 600px;
        text-align: center;
        transform: rotate(0.5deg);
      }

      .not-voting-phase h2 {
        font-family: var(--font-heading);
        font-size: 2rem;
        color: var(--color-ink);
        margin-bottom: 20px;
      }

      .voting-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 2rem;
        padding: 40px 20px;
      }

      .vote-card {
        background: var(--color-white);
        border: 4px solid var(--color-ink);
        border-radius: var(--radius-sketch);
        overflow: hidden;
        box-shadow: 4px 4px 0px var(--color-ink);
        transition: var(--transition);
        transform: rotate(calc(var(--vote-rotate, 0) * 1deg));
        position: relative;
      }

      .vote-card:nth-child(3n + 1) {
        --vote-rotate: -0.5;
      }
      .vote-card:nth-child(3n + 2) {
        --vote-rotate: 0.5;
      }
      .vote-card:nth-child(3n + 3) {
        --vote-rotate: -0.3;
      }

      .vote-card:hover {
        transform: translate(-3px, -3px) rotate(0deg) scale(1.02);
        box-shadow: 7px 7px 0px var(--color-ink);
        z-index: 10;
      }

      .rank-badge {
        position: absolute;
        top: 10px;
        left: 10px;
        width: 50px;
        height: 50px;
        background: var(--color-gold);
        border: 3px solid var(--color-ink);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-family: var(--font-heading);
        font-size: 1.5rem;
        font-weight: bold;
        box-shadow: 2px 2px 0px var(--color-ink);
        z-index: 5;
      }

      .rank-badge.gold {
        background: linear-gradient(135deg, #ffd700, #ffa500);
      }

      .rank-badge.silver {
        background: linear-gradient(135deg, #c0c0c0, #808080);
      }

      .rank-badge.bronze {
        background: linear-gradient(135deg, #cd7f32, #8b4513);
      }

      .vote-image {
        width: 100%;
        height: 250px;
        object-fit: cover;
        border-bottom: 3px solid var(--color-ink);
      }

      .vote-info {
        padding: 20px;
      }

      .vote-title {
        font-family: var(--font-heading);
        font-size: 1.5rem;
        color: var(--color-ink);
        margin-bottom: 10px;
      }

      .vote-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
      }

      .nominator {
        font-family: var(--font-sketch);
        color: var(--color-ink-light);
        font-size: 0.9rem;
      }

      .vote-count {
        background: var(--color-paper);
        padding: 8px 15px;
        border: 2px solid var(--color-ink);
        border-radius: 20px;
        font-family: var(--font-heading);
        font-size: 1.2rem;
        color: var(--color-ink);
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .vote-count-number {
        color: var(--color-accent);
        font-size: 1.5rem;
      }

      .vote-actions {
        display: flex;
        gap: 10px;
        margin-top: 20px;
      }

      .vote-btn {
        flex: 1;
        padding: 15px;
        background: var(--color-gold);
        color: var(--color-ink);
        border: 3px solid var(--color-ink);
        border-radius: var(--radius-sketch);
        font-family: var(--font-heading);
        font-size: 1.2rem;
        cursor: pointer;
        transition: var(--transition);
        box-shadow: 3px 3px 0px var(--color-ink);
        transform: rotate(-1deg);
      }

      .vote-btn:hover:not(:disabled) {
        transform: translate(-3px, -3px) rotate(-2deg);
        box-shadow: 6px 6px 0px var(--color-ink);
      }

      .vote-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .vote-btn.voted {
        background: var(--color-success);
        color: var(--color-white);
      }

      .vote-btn.voted::after {
        content: " ‚úì";
      }

      .share-btn {
        padding: 15px;
        background: var(--color-white);
        color: var(--color-ink);
        border: 3px solid var(--color-ink);
        border-radius: var(--radius-sketch);
        font-size: 1.2rem;
        cursor: pointer;
        transition: var(--transition);
        box-shadow: 3px 3px 0px var(--color-ink);
      }

      .share-btn:hover {
        transform: translate(-2px, -2px);
        box-shadow: 5px 5px 0px var(--color-ink);
      }

      .leaderboard {
        background: var(--color-white);
        border: 4px solid var(--color-ink);
        border-radius: var(--radius-sketch);
        padding: 30px;
        margin: 40px auto;
        max-width: 400px;
        box-shadow: 4px 4px 0px var(--color-ink);
        transform: rotate(-0.3deg);
        position: sticky;
        top: 100px;
      }

      .leaderboard h3 {
        font-family: var(--font-heading);
        font-size: 1.8rem;
        color: var(--color-ink);
        margin-bottom: 20px;
        text-align: center;
      }

      .leaderboard-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px;
        margin-bottom: 10px;
        background: var(--color-paper);
        border: 2px solid var(--color-ink);
        border-radius: var(--radius-sketch);
        transition: var(--transition);
      }

      .leaderboard-item:hover {
        transform: translateX(5px);
        box-shadow: 3px 3px 0px var(--color-ink);
      }

      .leaderboard-rank {
        width: 30px;
        height: 30px;
        background: var(--color-accent);
        color: var(--color-white);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-family: var(--font-heading);
        font-weight: bold;
      }

      .leaderboard-title {
        flex: 1;
        padding: 0 10px;
        font-family: var(--font-sketch);
        font-weight: 700;
      }

      .leaderboard-votes {
        font-family: var(--font-heading);
        font-size: 1.2rem;
        color: var(--color-accent);
      }

      .voting-container {
        display: grid;
        grid-template-columns: 1fr 400px;
        gap: 40px;
        max-width: 1600px;
        margin: 0 auto;
        padding: 40px 20px;
      }

      @media (max-width: 1200px) {
        .voting-container {
          grid-template-columns: 1fr;
        }

        .leaderboard {
          position: static;
          margin: 40px auto;
        }
      }

      @media (max-width: 768px) {
        .voting-grid {
          grid-template-columns: 1fr;
        }
      }

      .no-arch-warning {
        background: var(--color-accent);
        color: var(--color-white);
        padding: 15px;
        border: 3px solid var(--color-ink);
        border-radius: var(--radius-sketch);
        margin-top: 20px;
        text-align: center;
        font-family: var(--font-sketch);
        font-weight: 700;
      }
    </style>
  </head>
  <body>
    <nav class="navbar">
      <div class="container">
        <div class="nav-brand">
          <a href="index.html" class="logo-link">
            <img
              src="assets/img/Logo.png"
              alt="Archive of Meme"
              class="logo"
            />
          </a>
          <h1>Archive of Meme</h1>
          <span class="token-badge">$ARCH</span>
        </div>
        <ul class="nav-menu">
          <li><a href="index.html">Home</a></li>
          <li><a href="arch.html">Arch</a></li>
          <li><a href="nominate.html">Nominate</a></li>
          <li><a href="vote.html" class="active">Vote</a></li>
          <li><a href="archive.html">Archive</a></li>
          <li><a href="whitepaper.html">Whitepaper</a></li>
          <li><a href="profile.html">Profile</a></li>
        </ul>
        <button id="connectWallet" class="btn-wallet">Connect Wallet</button>
      </div>
    </nav>

    <div class="vote-hero">
      <h1
        style="
          font-family: var(--font-heading);
          font-size: 3.5rem;
          margin-bottom: 20px;
          text-shadow: 3px 3px 0px var(--color-ink);
        "
      >
        üó≥Ô∏è Vote for Today's Best Memes
      </h1>
      <p style="font-size: 1.3rem; margin-bottom: 30px">
        $ARCH holders decide what gets preserved forever
      </p>
      <div class="phase-indicator" style="max-width: 500px; margin: 0 auto">
        <div class="phase-bar">
          <div class="phase-progress" id="phaseProgress"></div>
        </div>
        <div class="phase-info">
          <span id="currentPhase">Voting Phase</span>
          <span id="phaseTimer">03:45:12 remaining</span>
        </div>
      </div>
    </div>

    <div class="vote-requirements">
      ‚ö†Ô∏è REQUIREMENTS: You need to hold $ARCH tokens to vote ‚Ä¢ 1 wallet = 1 vote
      per meme ‚Ä¢ Voting closes at 20:00 UTC
    </div>

    <!-- Show this when not in voting phase -->
    <div class="not-voting-phase" id="notVotingPhase" style="display: none">
      <h2>‚è∞ Not Voting Time Yet!</h2>
      <p
        style="
          font-family: var(--font-sketch);
          font-size: 1.2rem;
          margin-bottom: 20px;
        "
      >
        Voting happens daily from <strong>16:00 to 20:00 UTC</strong>
      </p>
      <p>Come back during voting hours to cast your votes!</p>
      <div style="margin-top: 30px">
        <a href="nominate.html" class="btn btn-primary"
          >Nominate Memes Instead</a
        >
      </div>
    </div>

    <!-- Main voting section -->
    <div class="voting-container" id="votingSection">
      <div>
        <div class="voting-grid" id="votingGrid">
          <!-- Memes will be loaded here dynamically -->
          <div style="grid-column: 1 / -1; text-align: center; padding: 60px 20px; color: var(--color-ink-light); font-family: var(--font-sketch); font-size: 1.2rem;">
            <p>Loading today's memes...</p>
            <p style="margin-top: 20px; font-size: 1rem;">If no memes appear, come back during voting phase (16:00-20:00 UTC)</p>
          </div>
        </div>
      </div>

      <!-- Live Leaderboard -->
      <div class="leaderboard">
        <h3>üèÜ Live Rankings</h3>
        <div id="leaderboardList">
          <div style="text-align: center; padding: 40px 20px; color: var(--color-ink-light); font-family: var(--font-sketch);">
            Rankings will appear during voting phase
          </div>
        </div>
        <div
          style="
            margin-top: 20px;
            text-align: center;
            font-family: var(--font-sketch);
            color: var(--color-ink-light);
          "
        >
          Top 3 will be archived at 20:00 UTC
        </div>
      </div>
    </div>

    <footer class="footer">
      <div class="container">
        <p>
          &copy; 2025 Archive of Meme. Preserving internet culture, one meme at
          a time.
        </p>
        <div class="footer-links">
          <a href="https://x.com" target="_blank">X</a>
          <a href="https://github.com/Archive-of-meme" target="_blank">GitHub</a>
        </div>
      </div>
    </footer>

    <div class="arch-decoration" title="Hi! I'm Arch!"></div>

    <!-- Solana Web3.js for Phantom integration -->
    <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
    <script src="js/phantom-integration.js"></script>
    <script src="js/wallet-simple.js"></script>
    <script src="js/arch-random.js"></script>
    <script>
      // Check if we're in voting phase
      function checkVotingPhase() {
        const now = new Date();
        const utcHour = now.getUTCHours();
        const utcMinute = now.getUTCMinutes();

        // Display current UTC time for debugging
        console.log(`Current UTC time: ${utcHour}:${utcMinute < 10 ? '0' : ''}${utcMinute}`);

        let currentPhase;
        let phaseMessage;
        let inVotingPhase = false;

        if (utcHour < 16) {
          currentPhase = 'nomination';
          phaseMessage = `‚è∞ Voting opens at 16:00 UTC (in ${16 - utcHour} hours)`;
        } else if (utcHour < 20) {
          currentPhase = 'voting';
          phaseMessage = `‚úÖ Voting Phase Active (until 20:00 UTC)`;
          inVotingPhase = true;
        } else {
          currentPhase = 'archive';
          phaseMessage = `üì¶ Archive Phase - Voting closed for today`;
        }

        console.log(`Current phase: ${currentPhase} - ${phaseMessage}`);

        // Update phase display
        const phaseDisplay = document.getElementById('phaseMessage');
        if (phaseDisplay) {
          phaseDisplay.textContent = phaseMessage;
        }

        // Show/hide voting section based on phase
        // For testing, we'll allow voting outside of hours but show warning
        if (!inVotingPhase) {
          const notVotingDiv = document.getElementById("notVotingPhase");
          if (notVotingDiv) {
            notVotingDiv.innerHTML = `
              <div style="background: #fff3cd; border: 3px solid #856404; padding: 30px; margin: 40px auto; max-width: 600px; border-radius: 15px; text-align: center;">
                <h2>üïê ${phaseMessage}</h2>
                <p style="font-size: 1.1rem; margin-top: 20px;">Voting is only open from <strong>16:00 to 20:00 UTC</strong> daily.</p>
                <p style="color: #856404; margin-top: 15px;">For testing purposes, you can still interact with the voting interface below.</p>
              </div>
            `;
            notVotingDiv.style.display = "block";
          }
          // Still show voting section for testing
          document.getElementById("votingSection").style.display = "grid";
        } else {
          document.getElementById("notVotingPhase").style.display = "none";
          document.getElementById("votingSection").style.display = "grid";
        }

        return inVotingPhase;
      }

      // Vote for a meme
      async function voteMeme(memeId) {
        // Check wallet connection
        const walletAddress = localStorage.getItem('testWallet') || (window.phantomWallet && window.phantomWallet.address);
        if (!walletAddress) {
          showNotification("Please connect your wallet to vote", "warning");
          return;
        }

        // Check $ARCH balance (using Phantom integration)
        let hasEnoughArch = false;
        if (window.phantomWallet && window.phantomWallet.isConnected) {
          // Real Phantom wallet - check actual balance
          await window.checkArchBalance();
          hasEnoughArch = window.phantomWallet.archBalance >= 100;
        } else {
          // Test wallet - assume they have enough
          hasEnoughArch = true;
        }

        if (!hasEnoughArch) {
          showNotification(
            `You need at least 100 $ARCH tokens to vote! Get some first.`,
            "error"
          );

          // Show where to get $ARCH
          const warningDiv = document.createElement("div");
          warningDiv.className = "no-arch-warning";
          warningDiv.style.cssText = `
            background: #dc3545;
            color: white;
            padding: 10px;
            margin-top: 10px;
            border-radius: 8px;
            font-size: 0.9rem;
          `;
          warningDiv.innerHTML =
            `Get $ARCH on <a href="https://raydium.io/swap/?inputCurrency=sol&outputCurrency=DmE9nZs4LfNCtMUHZWckstSHvHFCusBdGwjhqJuYpump" target="_blank" style="color: white; text-decoration: underline;">Raydium</a> or <a href="https://jup.ag" target="_blank" style="color: white; text-decoration: underline;">Jupiter</a>`;

          const voteBtn = event.target;
          voteBtn.parentElement.appendChild(warningDiv);

          setTimeout(() => warningDiv.remove(), 5000);
          return;
        }

        // Submit vote to backend
        const voterWallet = localStorage.getItem('testWallet') || localStorage.getItem('walletAddress') || '';

        fetch('/api/vote.php', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            meme_id: memeId,
            wallet: voterWallet
          })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Update UI to show voted
            const voteBtn = event.target;
            voteBtn.textContent = "VOTED";
            voteBtn.classList.add("voted");
            voteBtn.disabled = true;

            // Update vote count with actual count from backend
            const voteCount = voteBtn
              .closest(".vote-info")
              .querySelector(".vote-count-number");
            voteCount.textContent = data.newVoteCount || (parseInt(voteCount.textContent) + 1);

            showNotification("Vote submitted successfully!", "success");
          } else {
            showNotification(data.error || "Failed to submit vote", "error");
          }
        })
        .catch(error => {
          console.error("Vote submission error:", error);
          showNotification("Failed to submit vote. Please try again.", "error");
        });

        // Update leaderboard
        updateLeaderboard();
      }

      // Share meme
      function shareMeme(memeId) {
        const shareText = `Check out this meme on Archive of Meme! Vote with $ARCH to help preserve it forever! üó≥Ô∏è`;
        const shareUrl = `${window.location.origin}/vote.html#${memeId}`;

        if (navigator.share) {
          navigator.share({
            title: "Archive of Meme",
            text: shareText,
            url: shareUrl,
          });
        } else {
          // Fallback - copy to clipboard
          navigator.clipboard.writeText(`${shareText} ${shareUrl}`);
          showNotification("Link copied to clipboard!", "success");
        }
      }

      // Load memes for voting
      async function loadVotingMemes() {
        try {
          const response = await fetch('/api/get-todays-memes.php');
          const data = await response.json();

          const grid = document.getElementById('votingGrid');
          if (!grid) return;

          if (data.success && data.memes && data.memes.length > 0) {
            // Sort memes by vote count (if available)
            const sortedMemes = data.memes.sort((a, b) => (b.votes || 0) - (a.votes || 0));

            grid.innerHTML = sortedMemes.map((meme, index) => {
              const rankClass = index === 0 ? 'gold' : index === 1 ? 'silver' : index === 2 ? 'bronze' : '';
              return `
                <div class="vote-card">
                  <div class="rank-badge ${rankClass}">#${index + 1}</div>
                  <div style="width: 100%; height: 250px; overflow: hidden; background: var(--color-paper); border-bottom: 3px solid var(--color-ink);">
                    ${meme.image_url ?
                      `<img src="${meme.image_url}" alt="${meme.title}" style="width: 100%; height: 100%; object-fit: cover;">` :
                      `<div style="display: flex; align-items: center; justify-content: center; height: 100%; font-family: var(--font-sketch); color: var(--color-ink-light); font-size: 1.2rem;">[No Image]</div>`
                    }
                  </div>
                  <div class="vote-info">
                    <h3 class="vote-title">${meme.title || 'Untitled'}</h3>
                    <div class="vote-meta">
                      <span class="nominator">by ${meme.nominator_wallet ? meme.nominator_wallet.slice(0, 6) + '...' + meme.nominator_wallet.slice(-4) : 'Unknown'}</span>
                      <div class="vote-count">
                        <span class="vote-count-number">${meme.votes || 0}</span>
                        <span>votes</span>
                      </div>
                    </div>
                    <div class="vote-actions">
                      <button class="vote-btn" onclick="voteMeme('${meme.id}')">VOTE</button>
                      <button class="share-btn" onclick="shareMeme('${meme.id}')">üîó</button>
                    </div>
                  </div>
                </div>
              `;
            }).join('');

            updateLeaderboard(sortedMemes);
          } else {
            grid.innerHTML = `
              <div style="grid-column: 1 / -1; text-align: center; padding: 60px 20px; color: var(--color-ink-light); font-family: var(--font-sketch);">
                <p style="font-size: 1.3rem;">No memes nominated today yet!</p>
                <p style="margin-top: 20px;">Be the first to nominate a meme</p>
                <a href="nominate.html" class="btn btn-primary" style="margin-top: 20px; display: inline-block;">Nominate Now</a>
              </div>
            `;
          }
        } catch (error) {
          console.error('Error loading memes:', error);
        }
      }

      // Update leaderboard with real data
      function updateLeaderboard(memes) {
        const leaderboardList = document.getElementById('leaderboardList');
        if (!leaderboardList || !memes || memes.length === 0) return;

        leaderboardList.innerHTML = memes.slice(0, 5).map((meme, index) => `
          <div class="leaderboard-item">
            <div class="leaderboard-rank">${index + 1}</div>
            <div class="leaderboard-title">${meme.title || 'Untitled'}</div>
            <div class="leaderboard-votes">${meme.votes || 0}</div>
          </div>
        `).join('');
      }

      // Show notification function
      function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `notification notification-${type}`;
        notification.textContent = message;
        notification.style.cssText = `
          position: fixed;
          top: 80px;
          right: 20px;
          left: auto;
          max-width: 400px;
          padding: 15px 20px;
          background: ${type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : type === 'warning' ? '#ffc107' : '#17a2b8'};
          color: white;
          border: 3px solid #000;
          border-radius: 10px;
          box-shadow: 4px 4px 0px #000;
          z-index: 10000;
          font-family: var(--font-body);
        `;

        document.body.appendChild(notification);

        setTimeout(() => {
          notification.remove();
        }, 3000);
      }

      // Check phase on load
      checkVotingPhase();
      loadVotingMemes();

      // Check every minute
      setInterval(checkVotingPhase, 60000);

      // Reload memes every 30 seconds during voting
      setInterval(loadVotingMemes, 30000);
    </script>
  </body>
</html>
